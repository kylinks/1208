# 代理管理模块 - 完整功能总结

> 本文档总结了代理管理模块的所有前后端功能，可用于在其他项目中复刻相同功能。

---

## 一、模块概述

### 1.1 功能定位
代理管理模块用于管理代理IP供应商配置，支持动态认证信息生成、多供应商优先级管理、24小时IP去重机制。

### 1.2 技术栈
- **前端**: Next.js + React + Ant Design + TailwindCSS
- **后端**: Next.js API Routes
- **数据库**: MySQL + Prisma ORM
- **认证**: 账密认证方式

---

## 二、数据库模型

### 2.1 ProxyProvider（代理供应商表）

```prisma
model ProxyProvider {
  id             String          @id @default(uuid())
  /// 供应商名称
  name           String          @db.VarChar(100)
  /// 优先级（数字越小优先级越高）
  priority       Int             @default(0)
  /// 是否启用
  enabled        Boolean         @default(true)
  /// 成功率（百分比）
  successRate    Decimal?        @db.Decimal(5, 2)
  /// 最后一次失败时间
  lastFailedAt   DateTime?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  /// 认证密码（加密存储）
  password       String          @db.Text
  /// 代理服务器地址
  proxyHost      String          @db.VarChar(500)
  /// 代理服务器端口
  proxyPort      Int             @default(8080)
  /// 认证用户名（支持国家代码占位符，如：user-country-{country}）
  username       String          @db.VarChar(200)
  
  // 关联
  usedProxyIps   UsedProxyIp[]
  monitoringLogs MonitoringLog[]

  @@index([enabled, priority])
  @@map("ProxyProvider")
}
```

### 2.2 UsedProxyIp（已使用代理IP记录表）

```prisma
model UsedProxyIp {
  id          String        @id @default(uuid())
  /// 代理IP地址/Session标识
  ip          String        @db.VarChar(50)
  /// 代理端口
  port        Int
  /// 代理IP所属国家代码
  countryCode String        @db.VarChar(10)
  /// 关联的代理供应商ID
  providerId  String
  /// 关联的广告系列ID（按广告系列去重）
  campaignId  String
  /// 使用时间（用于24小时清理）
  usedAt      DateTime      @default(now())
  
  // 关联
  provider    ProxyProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  campaign    Campaign      @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([ip, campaignId, usedAt])
  @@index([usedAt])
  @@index([campaignId])
  @@index([providerId])
  @@map("UsedProxyIp")
}
```

---

## 三、后端API接口

### 3.1 代理供应商管理 API

#### 3.1.1 获取供应商列表
- **路径**: `GET /api/proxy-providers`
- **功能**: 获取所有代理供应商列表，按优先级和创建时间排序
- **响应**:
```typescript
interface ProxyProvider {
  id: string
  name: string
  proxyHost: string
  proxyPort: number
  username: string
  priority: number
  enabled: boolean
  successRate: number | null
  lastFailedAt: string | null
  createdAt: string
  updatedAt: string
}
```

#### 3.1.2 创建供应商
- **路径**: `POST /api/proxy-providers`
- **功能**: 创建新的代理供应商
- **请求体**:
```typescript
{
  name: string           // 供应商名称（必填）
  proxyHost: string      // 代理服务器地址（必填）
  proxyPort?: number     // 代理端口（默认8080）
  username: string       // 用户名，支持占位符（必填）
  password: string       // 密码（必填）
  priority?: number      // 优先级（默认0）
  enabled?: boolean      // 是否启用（默认true）
}
```

#### 3.1.3 更新供应商
- **路径**: `PUT /api/proxy-providers/[id]`
- **功能**: 更新指定供应商信息
- **请求体**: 同创建，字段可选

#### 3.1.4 删除供应商
- **路径**: `DELETE /api/proxy-providers/[id]`
- **功能**: 删除指定供应商

#### 3.1.5 测试连接（预留）
- **路径**: `POST /api/proxy-providers/[id]`
- **功能**: 测试代理连接（待实现）

---

### 3.2 代理获取与使用 API

#### 3.2.1 获取可用代理
- **路径**: `GET /api/proxy`
- **参数**:
  - `countryCode` (必填): 国家代码，如 US, AU
  - `campaignId` (必填): 广告系列ID，用于24小时去重
- **响应**:
```typescript
interface ProxyConfig {
  host: string           // 代理服务器地址
  port: number           // 代理端口
  username: string       // 替换占位符后的用户名
  password: string       // 替换占位符后的密码
  countryCode: string    // 国家代码
  providerId: string     // 供应商ID
  providerName: string   // 供应商名称
  sessionId: string      // Session标识，用于去重
}
```

#### 3.2.2 记录代理使用
- **路径**: `POST /api/proxy/record`
- **功能**: 记录代理IP使用情况，用于24小时去重
- **请求体**:
```typescript
{
  proxyConfig: ProxyConfig  // 代理配置对象
  campaignId: string        // 广告系列ID
}
```

#### 3.2.3 获取使用统计
- **路径**: `GET /api/proxy/stats`
- **参数**:
  - `campaignId` (必填): 广告系列ID
  - `countryCode` (可选): 国家代码过滤
- **响应**:
```typescript
{
  total: number                     // 总使用次数
  byProvider: Record<string, number> // 按供应商统计
  byCountry: Record<string, number>  // 按国家统计
  proxies: UsedProxyIp[]            // 使用记录列表
}
```

#### 3.2.4 清理过期记录
- **路径**: `POST /api/proxy`
- **功能**: 清理24小时前的代理使用记录
- **响应**:
```typescript
{
  success: boolean
  message: string
  count: number  // 清理的记录数
}
```

---

## 四、核心服务层

### 4.1 proxyService.ts - 代理服务

```typescript
// 文件位置: lib/proxyService.ts

// 1. 获取可用代理
export async function getAvailableProxy(
  countryCode: string,
  campaignId: string
): Promise<ProxyConfig | null>

// 2. 记录代理使用
export async function recordProxyUsage(
  proxyConfig: ProxyConfig,
  campaignId: string
): Promise<void>

// 3. 清理24小时前的记录
export async function cleanupOldProxyRecords(): Promise<number>

// 4. 获取使用统计
export async function getProxyUsageStats(
  campaignId: string,
  countryCode?: string
): Promise<ProxyStats | null>
```

### 4.2 proxyPlaceholder.ts - 占位符处理

```typescript
// 文件位置: lib/proxyPlaceholder.ts

/**
 * 支持的占位符：
 * - {country} - 国家代码(小写)，如: us, gb, au
 * - {COUNTRY} - 国家代码(大写)，如: US, GB, AU
 * - {session:N} - N位随机数字，如: {session:8} → 37557770
 * - {random:N} - N位随机字母数字，如: {random:10} → a3b9d2f8g1
 */

// 1. 替换占位符
export function replacePlaceholders(
  template: string,
  countryCode: string
): { result: string; sessionId: string }

// 2. 检测是否包含占位符
export function hasPlaceholders(str: string): boolean

// 3. 提取所有占位符
export function extractPlaceholders(str: string): string[]

// 示例配置
export const PLACEHOLDER_EXAMPLES = {
  country: { template: 'user-region-{country}', example: 'user-region-au' },
  COUNTRY: { template: 'user-region-{COUNTRY}', example: 'user-region-AU' },
  session: { template: 'user-session-{session:8}', example: 'user-session-37557770' },
  random: { template: 'user-id-{random:10}', example: 'user-id-a3b9d2f8g1' },
  combined: { 
    template: 'brd-customer-{country}-session-{session:8}', 
    example: 'brd-customer-us-session-37557770' 
  }
}
```

---

## 五、前端页面功能

### 5.1 页面位置
`app/(console)/console/proxy/page.tsx`

### 5.2 功能清单

#### 5.2.1 统计卡片区域
显示三个统计指标：
- **总供应商数**: 所有代理供应商的数量
- **已启用数**: 当前启用状态的供应商数量
- **平均成功率**: 所有启用供应商的平均成功率

#### 5.2.2 供应商列表表格
| 列名 | 说明 |
|------|------|
| 供应商名称 | 显示名称 |
| 代理服务器 | `proxyHost:proxyPort` 格式显示 |
| 用户名 | 支持占位符的用户名模板 |
| 优先级 | 数字越小优先级越高 |
| 成功率 | 进度条显示，带颜色状态 |
| 状态 | Switch开关控制启用/禁用 |
| 操作 | 测试、编辑、删除按钮 |

#### 5.2.3 新增/编辑弹窗表单
| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| 供应商名称 | Input | 是 | 如：Bright Data |
| 代理服务器地址 | Input | 是 | 如：brd.superproxy.io |
| 代理服务器端口 | InputNumber | 是 | 范围1-65535，默认8080 |
| 用户名 | Input | 是 | 支持占位符，显示帮助提示 |
| 密码 | Input.Password | 是 | 同样支持占位符 |
| 优先级 | InputNumber | 是 | 范围0-100，默认0 |
| 启用 | Switch | 否 | 默认启用 |

### 5.3 前端交互功能

```typescript
// 1. 页面加载时获取数据
useEffect(() => {
  fetchProviders()
}, [])

// 2. CRUD操作
const handleAdd = ()           // 打开新增弹窗
const handleEdit = (record)    // 打开编辑弹窗，填充数据
const handleDelete = (id)      // 删除确认后调用API
const handleSubmit = ()        // 表单提交（新增/更新）

// 3. 状态切换
const handleToggleEnabled = (id, enabled) // 切换启用状态

// 4. 连接测试（预留）
const handleTestConnection = (id) // 测试代理连接
```

### 5.4 使用的UI组件
```typescript
import {
  Table,           // 数据表格
  Button,          // 按钮
  Space,           // 间距容器
  Modal,           // 弹窗
  Form,            // 表单
  Input,           // 输入框
  InputNumber,     // 数字输入
  Switch,          // 开关
  message,         // 消息提示
  Popconfirm,      // 确认气泡
  Progress,        // 进度条
  Statistic,       // 统计数值
  Card,            // 卡片
  Row, Col,        // 栅格布局
} from 'antd'

import {
  PlusOutlined,         // 添加图标
  EditOutlined,         // 编辑图标
  DeleteOutlined,       // 删除图标
  ApiOutlined,          // API/连接图标
  CheckCircleOutlined,  // 勾选图标
} from '@ant-design/icons'
```

---

## 六、核心业务逻辑

### 6.1 24小时IP去重机制

```typescript
// 1. 获取代理时检查是否24小时内已使用
const twentyFourHoursAgo = new Date(Date.now() - 24 * 60 * 60 * 1000)

const usedProxy = await prisma.usedProxyIp.findFirst({
  where: {
    campaignId,
    providerId: provider.id,
    countryCode,
    ip: sessionId,  // 使用sessionId作为唯一标识
    usedAt: { gte: twentyFourHoursAgo }
  }
})

// 2. 如果未被使用，返回该代理配置
if (!usedProxy) {
  return proxyConfig
}
```

### 6.2 多供应商优先级选择

```typescript
// 按优先级排序获取供应商
const providers = await prisma.proxyProvider.findMany({
  where: { enabled: true },
  orderBy: [
    { priority: 'asc' },    // 优先级小的排前面
    { createdAt: 'desc' }   // 同优先级按创建时间
  ]
})

// 依次尝试每个供应商
for (const provider of providers) {
  // ... 尝试获取可用代理
}
```

### 6.3 占位符动态替换

```typescript
// 示例：user-region-{country}-session-{session:8}
// 请求AU代理时替换为：user-region-au-session-37557770

function replacePlaceholders(template, countryCode) {
  let result = template
  let sessionId = ''

  // 替换国家代码
  result = result.replace(/\{country\}/g, countryCode.toLowerCase())
  result = result.replace(/\{COUNTRY\}/g, countryCode.toUpperCase())

  // 替换随机session
  const sessionMatches = result.match(/\{session:(\d+)\}/g)
  if (sessionMatches) {
    sessionMatches.forEach(match => {
      const length = parseInt(match.match(/\d+/)?.[0] || '8')
      const randomDigits = generateRandomDigits(length)
      result = result.replace(match, randomDigits)
      if (!sessionId) sessionId = randomDigits
    })
  }

  // 替换随机字母数字
  const randomMatches = result.match(/\{random:(\d+)\}/g)
  if (randomMatches) {
    randomMatches.forEach(match => {
      const length = parseInt(match.match(/\d+/)?.[0] || '10')
      const randomStr = generateRandomAlphanumeric(length)
      result = result.replace(match, randomStr)
      if (!sessionId) sessionId = randomStr
    })
  }

  // 默认sessionId
  if (!sessionId) {
    sessionId = generateRandomDigits(8)
  }

  return { result, sessionId }
}
```

---

## 七、文件目录结构

```
project/
├── app/
│   ├── (console)/
│   │   └── console/
│   │       └── proxy/
│   │           └── page.tsx          # 前端页面
│   └── api/
│       ├── proxy/
│       │   ├── route.ts              # GET获取代理, POST清理记录
│       │   ├── record/
│       │   │   └── route.ts          # POST记录使用
│       │   └── stats/
│       │       └── route.ts          # GET使用统计
│       └── proxy-providers/
│           ├── route.ts              # GET列表, POST创建
│           └── [id]/
│               └── route.ts          # PUT更新, DELETE删除, POST测试
├── lib/
│   ├── proxyService.ts               # 代理核心服务
│   ├── proxyPlaceholder.ts           # 占位符处理工具
│   └── prisma.ts                     # Prisma客户端
└── prisma/
    └── schema.prisma                 # 数据模型定义
```

---

## 八、复刻步骤

### 8.1 数据库准备
1. 在 `prisma/schema.prisma` 中添加 `ProxyProvider` 和 `UsedProxyIp` 模型
2. 运行 `npx prisma db push` 或 `npx prisma migrate dev` 同步数据库

### 8.2 创建服务层
1. 创建 `lib/proxyPlaceholder.ts` - 占位符处理工具
2. 创建 `lib/proxyService.ts` - 代理核心服务

### 8.3 创建API路由
1. 创建 `app/api/proxy-providers/route.ts` - 列表和创建
2. 创建 `app/api/proxy-providers/[id]/route.ts` - 更新和删除
3. 创建 `app/api/proxy/route.ts` - 获取代理和清理
4. 创建 `app/api/proxy/record/route.ts` - 记录使用
5. 创建 `app/api/proxy/stats/route.ts` - 使用统计

### 8.4 创建前端页面
1. 创建 `app/(console)/console/proxy/page.tsx`
2. 引入 Ant Design 组件
3. 实现 CRUD 功能和统计展示

### 8.5 定时清理（可选）
设置定时任务每小时调用 `POST /api/proxy` 清理过期记录

---

## 九、待完善功能

| 功能 | 状态 | 说明 |
|------|------|------|
| 密码加密存储 | TODO | 建议使用 bcrypt 加密 |
| 连接测试 | TODO | 实现代理连接测试逻辑 |
| 成功率统计 | TODO | 根据使用记录自动计算 |
| 请求限流 | TODO | 按供应商限制请求频率 |
| 支持的国家列表 | 可选 | 模型预留了字段，前端未实现选择 |

---

## 十、API调用示例

### 10.1 完整使用流程

```typescript
// 1. 获取可用代理
const proxyRes = await fetch('/api/proxy?countryCode=US&campaignId=campaign-123')
const proxy = await proxyRes.json()

// 2. 使用代理执行任务
// ... 你的业务逻辑

// 3. 记录代理使用（成功后调用）
await fetch('/api/proxy/record', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    proxyConfig: proxy,
    campaignId: 'campaign-123'
  })
})
```

### 10.2 管理端操作

```typescript
// 获取所有供应商
const providers = await fetch('/api/proxy-providers').then(r => r.json())

// 创建供应商
await fetch('/api/proxy-providers', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    name: 'Bright Data',
    proxyHost: 'brd.superproxy.io',
    proxyPort: 22225,
    username: 'user-{country}-session-{session:8}',
    password: 'your_password',
    priority: 1,
    enabled: true
  })
})

// 切换启用状态
await fetch('/api/proxy-providers/provider-id', {
  method: 'PUT',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ enabled: false })
})

// 删除供应商
await fetch('/api/proxy-providers/provider-id', { method: 'DELETE' })
```

---

> **文档版本**: 1.0  
> **生成时间**: 2024年  
> **适用框架**: Next.js + Prisma + Ant Design
