# 控制台使用指南

本文档介绍控制台各个模块的功能和使用方法。

## 访问控制台

启动项目后,访问 `http://localhost:10111/console` 进入控制台首页。

## 功能模块

### 1. 控制台首页

**路径**: `/console`

**功能**:
- 展示系统关键指标:总广告系列数、活跃广告系列数、今日换链次数、换链成功率
- 展示今日点击数及变化趋势
- 展示最近活动列表,包括换链操作的实时状态

**特点**:
- 数据实时更新
- 一目了然的统计卡片
- 快速查看最近换链记录

---

### 2. 链接管理

**路径**: `/console/links`

**功能**:
- 查看所有联盟链接配置
- 添加新的联盟链接配置
- 编辑现有配置
- 启用/禁用链接配置
- 删除链接配置(软删除)

**操作说明**:

#### 添加链接配置
1. 点击右上角"添加链接配置"按钮
2. 填写必填信息:
   - **广告系列ID**: 关联的广告系列标识
   - **联盟链接**: 起始联盟链接URL
   - **目标根域名**: 最终落地页的域名(用于验证)
   - **国家代码**: 用于选择对应国家的代理IP
   - **最大跳转次数**: 默认10次
   - **优先级**: 数字越小优先级越高
3. 点击"确定"保存

#### 编辑配置
1. 在列表中找到目标配置
2. 点击"编辑"按钮
3. 修改信息后保存

#### 启用/禁用
- 使用列表中的开关快速启用或禁用配置
- 禁用后该配置不会参与自动换链

---

### 3. MCC管理

**路径**: `/console/mcc`

**功能**:
- 管理 Google Ads MCC 账号
- 查看授权状态
- 执行授权流程
- 同步广告系列数据
- 删除MCC账号(软删除)

**操作说明**:

#### 添加MCC账号
1. 点击"添加MCC账号"按钮
2. 填写:
   - **MCC账号ID**: 格式 123-456-7890
   - **账号名称**: 便于识别的名称
3. 保存后,点击"授权"按钮完成OAuth授权

#### 授权流程
1. 对于"待授权"状态的账号,点击"授权"按钮
2. 系统会跳转到 Google OAuth 授权页面
3. 授权成功后,状态变更为"已授权"

#### 同步数据
- 对于已授权的账号,点击"同步"按钮
- 系统会拉取该MCC下的所有广告系列数据

**授权状态说明**:
- **待授权**: 新创建的账号,需要完成OAuth授权
- **已授权**: 授权成功,可以正常使用
- **已过期**: 授权令牌过期,需要重新授权
- **授权失败**: 授权过程失败,需要检查配置

---

### 4. 代理管理

**路径**: `/console/proxy`

**功能**:
- 管理代理供应商
- 配置代理优先级
- 测试代理连接
- 查看成功率统计
- 启用/禁用代理供应商

**操作说明**:

#### 添加代理供应商
1. 点击"添加代理供应商"按钮
2. 填写信息:
   - **供应商名称**: 如 Bright Data
   - **API端点**: 代理API的URL
   - **API密钥**: 供应商提供的密钥(加密存储)
   - **API密钥Secret**: 密钥Secret(加密存储)
   - **优先级**: 数字越小优先级越高,系统按优先级顺序尝试
   - **每分钟最大请求数**: 限制请求频率
3. 保存后,建议点击"测试"验证连接

#### 测试连接
- 点击列表中的"测试"按钮
- 系统会尝试从该供应商获取代理IP并进行测试
- 测试结果会显示在通知中

#### 优先级说明
- 系统会按优先级从低到高的顺序使用代理
- 当高优先级代理失败时,会自动切换到下一个
- 建议将最稳定的供应商设置为高优先级(数字小)

**统计指标**:
- **总供应商**: 所有代理供应商数量
- **已启用**: 当前启用的供应商数量
- **平均成功率**: 所有启用供应商的平均成功率

---

### 5. 系统设置

**路径**: `/console/settings`

**功能**:
- 配置系统全局参数
- 设置监控规则
- 配置告警通知

**设置项说明**:

#### 监控设置
- **监控间隔**: 系统每隔N分钟检查一次广告系列点击数(默认5分钟)
- **最大跳转次数**: 跟随联盟链接时的最大重定向次数(默认10次)
- **请求超时**: 访问联盟链接的超时时间(秒)
- **重试次数**: 失败后的重试次数
- **启用自动换链**: 是否自动执行换链操作
- **启用代理轮换**: 24小时内不重复使用同一代理IP

#### 自动清理
- **自动清理天数**: 自动清理N天前的已使用代理IP记录

#### 监控告警
- **启用告警**: 总开关
- **失败次数阈值**: 连续失败N次后触发告警
- **告警邮箱**: 接收告警的邮箱地址
- **Webhook URL**: 接收告警的Webhook地址(如Slack、企业微信等)

**使用建议**:
- 根据实际需求调整监控间隔,过于频繁会增加API调用次数
- 设置合理的超时时间,避免长时间等待
- 配置告警通知,及时发现问题

---

### 6. 日志查看

**路径**: `/console/logs`

**功能**:
- 查看监控日志(换链操作记录)
- 按条件筛选和搜索
- 查看详细信息

**监控日志**:

显示每次换链操作的详细信息:
- 触发时间
- 广告系列名称
- 点击数变化(上次点击 → 今日点击)
- 使用的代理IP和端口
- 跳转次数
- 执行状态(成功/失败/跳过)
- 执行耗时

**筛选功能**:
- 时间范围筛选
- 按状态筛选(成功/失败/跳过)
- 按广告系列搜索

**查看详情**:
- 点击"详情"按钮查看完整信息
- 包括联盟链接、最终URL、错误信息等

**使用场景**:
- 排查换链失败原因
- 监控系统运行状态
- 分析换链成功率

---

## 数据流程

1. **监控阶段**: 系统每隔N分钟检查广告系列的点击数
2. **触发判定**: 当 todayClicks > lastClicks 时,触发换链流程
3. **代理获取**: 根据国家代码和优先级选择代理IP
4. **链路追踪**: 使用代理访问联盟链接,跟随重定向
5. **域名验证**: 检查最终URL的根域名是否匹配目标域名
6. **更新Final URL**: 调用 Google Ads API 更新广告的最终URL
7. **记录日志**: 写入监控日志,更新点击数和换链计数

## 最佳实践

### 配置管理
- 为每个广告系列配置独立的联盟链接
- 设置合理的优先级,确保主链接优先使用
- 定期检查配置的启用状态

### 代理管理
- 配置多个代理供应商,确保容错能力
- 根据成功率调整优先级
- 定期测试代理连接
- 设置合理的请求频率限制

### 监控与告警
- 配置邮件和Webhook告警
- 设置合理的失败阈值
- 定期查看监控日志
- 关注成功率变化

### 安全建议
- 定期更新API密钥
- 控制用户权限
- 定期备份数据库

## 常见问题

**Q: 为什么换链失败?**
A: 检查以下方面:
1. 代理IP是否可用
2. 联盟链接是否有效
3. 跳转次数是否超限
4. 目标域名配置是否正确
5. Google Ads API授权是否过期

**Q: 如何提高换链成功率?**
A: 
1. 配置多个代理供应商
2. 增加重试次数
3. 调整超时时间
4. 选择稳定的代理服务

**Q: 点击数不更新怎么办?**
A: 
1. 检查MCC授权状态
2. 尝试手动同步数据
3. 检查监控任务是否运行
4. 查看监控日志中的错误信息

## 技术支持

遇到问题请:
1. 查看监控日志
2. 检查系统设置是否正确
3. 参考 PRD.md 了解系统设计
4. 参考 INSTALL.md 了解安装步骤
